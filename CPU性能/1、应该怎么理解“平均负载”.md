# 怎么理解“平均负载”

## 什么是平均负载
    
> 平均负载是指单位时间内，系统处于**可运行状态**和**不可中断状态**的平均进程数，也就是平均活跃进程数，它和 CPU 使用率并没有直接关系。

> 形象点表述，就是在服务器中正在为我们工作的进程，以及帮助我们把守关键岗位的进程。

### 可运行状态的进程

> 指正在使用 CPU 或者正在等待 CPU 的进程，也就是我们常用 ps 命令看到的，处于 R 状态（Running 或 Runnable）的进程。

### 不可中断状态的进程

> 正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I/O 响应，也就是我们在 ps 命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程。

**不可中断状态实际上是系统对进程和硬件设备的一种保护机制**


## 平均负载为多少合理
> 平均负载最理想的情况是等于CPU个数，当平均负载比 CPU 个数还大的时候，系统已经出现了过载。

## 平均负载与 CPU 使用率
在这里，需要说明的下，以前关于负载这块，多数时间都是通过top命令来查看当前服务器的cpu和内存的使用情况，通过倪老师的讲解才发现自己的理解错误。

> 划重点 **平均负载不等同 CPU使用率**

在一些不同情况下，两者的关系
- CPU 密集型进程，使用大量 CPU 会导致平均负载升高，此时这两者是一致的；
- I/O 密集型进程，等待 I/O 也会导致平均负载升高，但 CPU 使用率不一定很高；
- 大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高。


##  iostat、mpstat、pidstat负载工具的使用

电脑配置 8cpu 8G 

**stress 和 sysstat工具包**

stress 是一个 Linux 系统压力测试工具，这里我们用作异常进程模拟平均负载升高的场景。

sysstat 包含了常用的 Linux 性能工具，用来监控和分析系统的性能。

测试前的负载
    
    $ uptime
     10:53:14 up 19 days, 25 min,  2 users,  load average: 0.11, 0.61, 0.55

### 场景一：CPU 密集型进程
在第一个终端运行 stress 命令，模拟一个 CPU 使用率 100% 的场景

    $ stress --cpu 1 --timeout 600
    stress: info: [22308] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd

第二个终端运行 uptime 查看平均负载的变化情况：

    # -d 参数表示高亮显示变化的区域
    $ watch -d uptime
    
    $ uptime
     10:55:47 up 19 days, 27 min,  2 users,  load average: 0.68, 0.58, 0.54
第三个终端运行 mpstat 查看 CPU 使用率的变化情况：

	# -P ALL 表示监控所有 CPU，后面数字 5 表示间隔 5 秒后输出一组数据
	$ mpstat -P ALL 5

	10时57分13秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
	10时57分18秒  all   14.41    0.00    0.35    0.83    0.00    0.08    0.00    0.00    0.00   84.34
	10时57分18秒    0    1.80    0.00    0.20    1.60    0.00    0.00    0.00    0.00    0.00   96.40
	10时57分18秒    1    3.21    0.00    0.60    0.00    0.00    0.00    0.00    0.00    0.00   96.19
	10时57分18秒    2    5.61    0.00    0.80    0.00    0.00    0.00    0.00    0.00    0.00   93.59
	10时57分18秒    3    2.79    0.00    0.40    0.00    0.00    0.40    0.00    0.00    0.00   96.41
	10时57分18秒    4  100.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00
	10时57分18秒    5    0.80    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.20
	10时57分18秒    6    0.80    0.00    0.20    1.80    0.00    0.20    0.00    0.00    0.00   97.01
	10时57分18秒    7    0.40    0.00    0.60    3.20    0.00    0.00    0.00    0.00    0.00   95.80

### 场景二：I/O 密集型进程

第一个终端运行

    stress -i 1 --timeout 600

第二、三个终端运行 同场景一

### 场景三：大量进程的场景

第一个终端运行

    stress -c 16 --timeout 600
	这里将c改为16 主要是因为机器是8cpu，增加抢夺的进程


第二、三个终端运行 同场景一

通过stress工具对服务器的负载情况进行模拟请求，通过mpstat对每个cpu的性能指标和所有cpu的平均指标进行查看


**小结**
- 平均负载高有可能是 CPU 密集型进程导致的； 
- 平均负载高并不一定代表 CPU 使用率高，还有可能是 I/O 更繁忙了； 
- 当发现负载高的时候，你可以使用 mpstat、pidstat 等工具，辅助分析负载的来源。